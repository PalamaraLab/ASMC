name: Ubuntu coverage

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  build-and-test:
    name: Coverage on Ubuntu
    runs-on: ubuntu-24.04
    if: ${{ github.repository == 'PalamaraLab/ASMC' }}
    timeout-minutes: 10

    steps:

      - name: checkout repo & submodules
        uses: actions/checkout@v5
        with:
          submodules: true
          fetch-depth: 0

      - name: install deps
        run: |
          sudo apt -y update
          sudo apt -y install libboost-iostreams-dev libboost-program-options-dev zlib1g-dev

      - name: install tools
        run: |
          sudo apt -y update
          sudo apt -y install lcov libcurl4-openssl-dev

      - name: make build directory
        run: mkdir -p build_dir

      - name: configure
        run: |
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DASMC_ENABLE_COVERAGE=ON
        working-directory: build_dir

      - name: build
        run: |
          cmake --build . --parallel 2 --target ASMC_unit_tests
        working-directory: build_dir

      - name: test
        run: |
          ctest -j2 -R Asmc_unit_tests --output-on-failure
        working-directory: build_dir

      - name: process coverage
        run: |
          lcov --directory . --capture --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/test/*' '*/vcpkg_installed/*' --output-file coverage.info
          lcov --list coverage.info
        working-directory: build_dir

      - name: upload coverage to codecov
        run: |
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov
        working-directory: build_dir
